<?xml version="1.0" encoding="utf-8" ?>
<pages:BasePage xmlns="http://xamarin.com/schemas/2014/forms"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:pages="clr-namespace:BLE.Client.Pages;assembly=BLE.Client"
             xmlns:abstractions="clr-namespace:Plugin.BLE.Abstractions;assembly=Plugin.BLE.Abstractions"
             x:Class="BLE.Client.Pages.DeviceListPage"
             Title="Discover devices"
             x:Name="DevicePage">
  <Grid>
    <Grid.RowDefinitions>
      <RowDefinition></RowDefinition>
      <RowDefinition Height="Auto"></RowDefinition>
    </Grid.RowDefinitions>
    <ListView ItemsSource="{Binding Devices}" SelectedItem="{Binding SelectedDevice, Mode=TwoWay}"
             IsPullToRefreshEnabled="True"
             RefreshCommand="{Binding RefreshCommand}"
             IsRefreshing="{Binding IsRefreshing, Mode=OneWay}"
             RowHeight="80">
      <ListView.ItemTemplate>
        <DataTemplate>
          <ViewCell>
            <ViewCell.ContextActions>
              <MenuItem Command="{Binding Path=BindingContext.DisconnectCommand, Source={x:Reference DevicePage}}"
                        CommandParameter="{Binding .}"
                        Text="Disconnect"/>
            </ViewCell.ContextActions>
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition></ColumnDefinition>
                <ColumnDefinition Width="Auto"></ColumnDefinition>
              </Grid.ColumnDefinitions>
              <Grid.Triggers>
                <DataTrigger TargetType="Grid"
                             Binding="{Binding State}"
                             Value="{x:Static abstractions:DeviceState.Connected}">
                  <Setter Property="BackgroundColor" Value="#1A00FF00"></Setter>
                </DataTrigger>
              </Grid.Triggers>
              <StackLayout Orientation="Vertical" VerticalOptions="Center">
                <Label Text="{Binding Name}" FontSize="Large" />
                <Label Text="{Binding Id, StringFormat='{0}'}" TextColor="Gray" FontSize="Small"/>
              </StackLayout>
              <Label Grid.Column="1"
                     Margin="10"
                     Text="{Binding Rssi}"
                     VerticalTextAlignment="Center"></Label>
            </Grid>
          </ViewCell>
        </DataTemplate>
      </ListView.ItemTemplate>
    </ListView>

    <StackLayout Grid.Row="1" Orientation="Horizontal">
      <Button Text="Connect to previous" Command="{Binding ConnectToPreviousCommand}" HorizontalOptions="FillAndExpand"/>
      <Button Text="Stop Scan" Command="{Binding StopScanCommand}" HorizontalOptions="End"/>
      <ActivityIndicator IsRunning="{Binding IsRefreshing}" 
                         HeightRequest="24" 
                         WidthRequest="24" 
                         VerticalOptions="Center"
                         HorizontalOptions="End"/>
    </StackLayout>
  </Grid>

</pages:BasePage>